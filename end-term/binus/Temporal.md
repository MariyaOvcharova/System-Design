# Как Temporal помогает не потерять вашу пиццу #

Ссылка на видео:[
https://www.youtube.com/watch?v=iOfR0YtaWMc](https://www.youtube.com/watch?v=LsWQdfHMsXE)

Ссылка на презентацию: https://disk.yandex.ru/i/sZ0W2HRBzsy5FA
## Основная мысль ##

Temporal - это инструмент который помогает описывать бизнес процессы в коде так чтобы они были надёжные долговременные и не ломались даже если свет выключится сервера упадут или интернет пропадет  
Антон Цитульский (тот кто защищал презентацию) рассказывает на примере сервиса доставки еды как с помощью Temporal можно гарантировать что заказ (например пицца) точно будет обработан и доставлен без потерь и ошибок

## Почему выбрали Temporal ##

- Нужно было чтобы заказы на еду обрабатывались быстро и надёжно
- Бизнес процесс оформления заказа довольно сложный - надо списать деньги с клиента, передать заказ в кафе, дождаться когда приготовят, вызвать курьера и всё это в короткие сроки
- Важно чтобы процессы можно было восстанавливать если что-то сломается по дороге
- Temporal открытый (open-source) можно развернуть у себя в датацентре бесплатно и настраивать как хочется

### Что такое Temporal ###

- Temporal это оркестратор бизнес процессов
- Его придумали в Uber на основе старого проекта Cadence
- Он управляет ходом выполнения задач - сам код выполняется на ваших воркерах, а Temporal только следит чтобы всё шло как надо
- Temporal сохраняет все события что происходят с процессом - чтобы можно было в любой момент восстановиться

### Как устроен Temporal внутри ###

- Frontend Service - шлюз для общения через gRPC
- Matching Service - управляет очередями задач для воркеров
- History Service - хранит события и стейт бизнес процессов
- Internal Worker Service - делает всякие внутренние задачи типа архивации и репликации

### Как писать процессы с Temporal ###

- Бизнес процесс называется Workflow
- Внутри Workflow можно вызывать Activity - это отдельные действия типа похода в платежный шлюз
- Всё пишется в коде через SDK - на Go, Java или другом языке
- Важно чтобы код Workflow был детерминированным - всегда выполнялся одинаково на одинаковых входах
- Есть готовые методы для выполнения Activity и Workflow через обертки типа ExecuteActivity и ExecuteWorkflow

### Что происходит когда приходит заказ ###

1. Приложение отправляет команду на запуск Workflow
2. Историк сохраняет событие о старте
3. Worker берет задачу на выполнение
4. В процессе Workflow вызывается Activity например списать деньги
5. Если всё ок Workflow завершается
6. Если что-то ломается можно восстановиться по истории событий

- Пример Activity: сделать запрос в платежную систему чтобы списать деньги
- Пример Workflow: оформить заказ -> оплатить -> передать заказ в кафе -> дождаться готовности -> вызвать курьера -> доставить заказ
- Если во время оплаты случится ошибка Temporal сам ретрайнет несколько раз а если не получится правильно проставит статус отказа

### Почему Temporal не теряет заказы ###

- Каждое действие сохраняется в базу
- Если сервер упал воркер может переподнять состояние по Event History
- Есть механизмы для отказоустойчивости типа Replay
- Есть лимиты на размер истории чтобы база не захлебнулась
- Старые данные архивируются через 30 дней

- Когда бизнес логика меняется надо аккуратно поддерживать старые процессы через GetVersion иначе можно получить ошибку недетерминизма и процесс упадет
- Воркеры можно версионировать чтобы старые заказы обрабатывались старыми воркерами а новые новыми

### Сколько кода нужно писать ###

- Нужно написать функции для Activity и Workflow
- Подключить воркеры через SDK
- Запускать процессы через ExecuteWorkflow
- Вся сложная инфраструктура типа восстановления и ретраев идёт из коробки

Антон показал что такие штуки как Temporal это реально удобно и понятно даже для обычного среднего проекта  
Всё пишется как обычный код без каких то страшных схем как в других системах 
И ещё Temporal реально спасает если что-то падает потому что весь прогресс процесса сохраняется шаг за шагом это очень круто особенно в доставке еды где каждая секунда на счету  

## Вывод ##

Temporal - это мощный инструмент чтобы строить надёжные бизнес процессы без боли  
Он помогает не терять данные даже в случае сбоев  
Он помогает кодить процессы легко как обычные функции без лишней магии  
Если надо чтобы заказы на еду или что-то другое шли чётко и без потерь - Temporal это отличное решение


