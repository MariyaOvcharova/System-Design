# Эволюция и мифы CQRS

Ссылка на видео: https://www.youtube.com/watch?v=PTr2xHr7nug
Ссылка на презентацию: https://disk.yandex.ru/i/4Q5uG2KFucCgvg

## Основная мысль

CQRS - это архитектурный подход, который разделяет операции записи и чтения данных. Это позволяет упростить поддержку кода, повысить его читаемость и ускорить развитие продукта. Главное преимущество CQRS - возможность оптимизировать чтение и запись независимо друг от друга.

## Зачем нужен CQRS

Когда приложение растет, увеличивается количество операций чтения. Большинство пользователей в основном читают данные - например, смотрят товары, новости или мемы.) Разделение чтения и записи позволяет оптимизировать каждый процесс отдельно и избежать перегрузки базы данных.

## Как работает CQRS

Изначально сервисы совмещали в себе чтение и запись:
```
public class OrderService
{
    public OrderDto CreateOrder() { /* create order */ }
    public List<OrderDto> GetOrders() { /* get orders */ }
}
```

При применении CQRS каждую операцию разделяют на * команду * (Command) или * запрос * (Query) и отдельный * обработчик * (Handler):

```
public class CreateOrderCommand {}
public class CreateOrderCommandHandler 
{
    public OrderDto Handle(CreateOrderCommand command) { /* create order */ }
}

public class GetOrdersQuery {}
public class GetOrdersQueryHandler 
{
    public List<OrderDto> Handle(GetOrdersQuery query) { /* get orders */ }
}
```

### Преимущества применения CQRS

- Маленькие обработчики, понятные и ограниченные по ответственности
- Явные зависимости между операциями
- Упрощенная поддержка кода
- Возможность централизованно добавлять метрики, логи, валидации

### Недостатки

- Увеличивается количество файлов и папок
- Для простых CRUD-приложений применение CQRS может быть излишним и усложнять архитектуру
- Масштабирование с использованием CQRS
- При росте нагрузки CQRS позволяет:
- Разделить базы данных для чтения и записи
- Использовать реплики баз для ускорения чтения
- Внедрить кэширование и денормализацию данных (например, через ElasticSearch)
- В коде строго различают команды для записи и запросы для чтения.
- Отдельные модели для чтения

Когда обычного кэширования становится недостаточно, создаются специальные модели чтения (Read Model). Они обновляются либо синхронно вместе с записью, либо асинхронно через события и очереди.

### Типовая схема:

` Запись в основную базу → Событие → Обновление Read Model `

## Мифы о CQRS

Query меняет данные - нет, Query предназначен только для чтения.
Query обязан работать только с ReadModel - нет, он может обращаться к основной модели, если требуется.
Command не может возвращать результат - может, особенно в случае успешного создания объекта или ошибки.
Command не может читать ReadModel - может, но данные могут быть неактуальными.

### Выводы ###

CQRS - это рабочий инструмент,его стоит применять тогда, когда есть потребность разделять процессы чтения и записи. При правильном использовании он помогает сделать систему масштабируемой и удобной для разработки.

Применение CQRS без реальной необходимости приводит только к усложнению проекта.





